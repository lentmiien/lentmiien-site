extends layout

block content
  .row
    .col-lg-8
      h1.mb-3 TTS API Test
      p.text-muted.mb-4
        | API base: 
        code= apiBase
        |  - generates audio and saves it to 
        code public/temp
        | .

      if error
        .alert.alert-danger(role="alert")= error
      if info
        .alert.alert-info(role="alert")= info
      if result
        .alert.alert-success(role="alert")
          | Audio generated and saved as 
          code= result.fileName
          if result.voiceId
            |  using voice 
            code= result.voiceId
            | .
          else
            |  with the default voice.
          br
          a(href=result.fileUrl, target="_blank") Open file in new tab

      form.card.mb-4(method="post", action="/admin/tts-test")
        .card-body
          .mb-3
            label.form-label(for="text") Text to synthesize
            textarea#text.form-control(name="text", rows="4", required, placeholder="Add tone markers like (excited) to guide delivery")= form.text
            small.form-text.text-muted Use the keyword list on the right to steer emotion and tone.
          .mb-3
            label.form-label(for="voice_id") Voice
            if voices && voices.length
              select#voice_id.form-select(name="voice_id")
                option(value="", selected=!form.voiceId && defaultVoiceId) Default (#{defaultVoiceId || 'auto'})
                each v in voices
                  - const isSelected = form.voiceId === v.voiceId;
                  option(value=v.voiceId, selected=isSelected)= `${v.displayName || v.voiceId} (${v.language || v.backend || 'voice'})`
              small.form-text.text-muted Voices are fetched from #{apiBase}/tts/voices.
            else
              input#voice_id.form-control(type="text", name="voice_id", value=form.voiceId || defaultVoiceId || '', placeholder="voice id (e.g. piper_en)")
              small.form-text.text-muted Unable to load voice list; enter a voice id manually.
          p.text-muted.mb-3 Output is saved to 
            code public/temp
            |  using the format returned by the API (typically wav).
          button.btn.btn-primary(type="submit") Generate audio

      if job
        .card.mb-4
          .card-body
            h5.mb-3 Job status
            p.mb-1
              | Job ID: 
              code= job.id
            p.mb-2
              strong Status: 
              span#job-status= job.status
            p.text-danger#job-error(class=job.error ? '' : 'd-none')= job.error
            #job-result-container.mt-3
              if job.result
                h6.mb-3 Preview
                audio#job-audio(controls, class="w-100 mb-2", src=job.result.fileUrl)
                p.mb-0
                  | Saved to 
                  code#job-file-name= job.result.fileName
                  | . 
                  a#job-file-link(href=job.result.fileUrl, target="_blank") Open file in new tab
              else
                p#job-result-placeholder.text-muted.mb-0 Waiting for audio...
                .d-none#job-result-preview
                  h6.mb-3 Preview
                  audio#job-audio(controls, class="w-100 mb-2")
                  p.mb-0
                    | Saved to 
                    code#job-file-name
                    | . 
                    a#job-file-link(target="_blank") Open file in new tab
      else if result
        .card
          .card-body
            h5.mb-3 Preview
            audio(controls, class="w-100 mb-2", src=result.fileUrl)
            p.mb-0
              | Saved to 
              code public/temp/#{result.fileName}
              | . Download or share directly via the link above.
      if voices && voices.length
        .card
          .card-body
            h5.mb-3 Available voices
            ul.list-unstyled.mb-0
              each v in voices
                li.mb-1
                  strong= v.displayName || v.voiceId
                  |  â€” 
                  code= v.voiceId
                  if v.language || v.backend
                    span.text-muted.ms-1= `(${[v.language, v.backend].filter(Boolean).join(', ')})`
    .col-lg-4
      .card
        .card-body
          h5.mb-3 Keyword cheatsheet
          if keywords
            h6.text-uppercase.fs-6.mb-2 Basic emotions
            if keywords.basicEmotions && keywords.basicEmotions.length
              each kw in keywords.basicEmotions
                span.badge.text-bg-light.border.me-1.mb-1= kw
            h6.text-uppercase.fs-6.mt-3.mb-2 Advanced emotions
            if keywords.advancedEmotions && keywords.advancedEmotions.length
              each kw in keywords.advancedEmotions
                span.badge.text-bg-light.border.me-1.mb-1= kw
            h6.text-uppercase.fs-6.mt-3.mb-2 Tone markers
            if keywords.toneMarkers && keywords.toneMarkers.length
              each kw in keywords.toneMarkers
                span.badge.text-bg-light.border.me-1.mb-1= kw
            h6.text-uppercase.fs-6.mt-3.mb-2 Special audio effects
            if keywords.audioEffects && keywords.audioEffects.length
              each kw in keywords.audioEffects
                span.badge.text-bg-light.border.me-1.mb-1= kw
  if job && job.status !== 'completed' && job.status !== 'failed'
    script.
      (() => {
        const jobId = '#{job.id}';
        const statusEl = document.getElementById('job-status');
        const errorEl = document.getElementById('job-error');
        const placeholderEl = document.getElementById('job-result-placeholder');
        const previewEl = document.getElementById('job-result-preview');
        const audioEl = document.getElementById('job-audio');
        const fileNameEl = document.getElementById('job-file-name');
        const fileLink = document.getElementById('job-file-link');

        async function poll() {
          try {
            const res = await fetch(`/admin/tts-test/status/${jobId}`);
            if (res.status === 404) {
              if (statusEl) statusEl.textContent = 'not_found';
              if (errorEl) {
                errorEl.textContent = 'Job not found or expired.';
                errorEl.classList.remove('d-none');
              }
              clearInterval(timer);
              return;
            }
            if (!res.ok) return;
            const data = await res.json();
            if (statusEl) statusEl.textContent = data.status || 'unknown';
            if (data.error && errorEl) {
              errorEl.textContent = data.error;
              errorEl.classList.remove('d-none');
            }
            if (data.result && data.result.fileUrl && previewEl && audioEl) {
              if (placeholderEl) placeholderEl.classList.add('d-none');
              previewEl.classList.remove('d-none');
              audioEl.src = data.result.fileUrl;
              if (fileNameEl) fileNameEl.textContent = data.result.fileName || 'audio.wav';
              if (fileLink) {
                fileLink.href = data.result.fileUrl;
                fileLink.textContent = 'Open file in new tab';
              }
            }
            if (['completed', 'failed', 'not_found'].includes(data.status)) {
              clearInterval(timer);
            }
          } catch (err) {
            // transient errors ignored; next tick will retry
          }
        }

        const timer = setInterval(poll, 2500);
        poll();
      })();
