extends layout

block styles
  link(rel='stylesheet', href='/css/es_dashboard.css')

block content
  .es-dashboard
    .es-dashboard__intro
      h1 Emergency Stock Dashboard
      p.es-dashboard__tagline Keep your household resilient with a quick glance at status and to-do items.
      .es-dashboard__links
        a.es-link(href='/es/es_view_stock') View current stock
        a.es-link(href='/i/es.jpg') 3 person household (original list)
    .es-dashboard__preparedness
      .es-card
        .es-card__header
          span.es-card__eyebrow Overall Preparedness
          span.es-card__figure #{average}%
        .es-progress
          .es-progress__track
            .es-progress__bar(style=`width: ${average}%;`)
          span.es-progress__label= `${average}% stocked`
    .es-dashboard__grid
      .es-dashboard__column
        if items.length > 0
          .es-card
            .es-card__header
              h2 Items to Rotate
              span.es-card__meta= `${items.length} items`
            ul.es-item-list
              each item in items
                - const stock = category_lookup_and_stock[item.categoryId];
                li.es-item
                  .es-item__details
                    span.es-item__category= stock && stock.label ? stock.label : 'Unknown category'
                    if item.label
                      span.es-item__label= item.label
                  .es-item__meta
                    span Amount: #{item.amount} #{stock ? stock.unit : ''}
                    span Rotate by #{item.rotateDate.toDateString()}
                  .es-item__actions
                    button(type='button', class='es-button es-button--ghost fill-add-item', data-category=item.categoryId.toString(), data-amount=item.amount, data-label=item.label || '') Restock
        else
          .es-card
            .es-card__header
              h2 Items to Rotate
            p.es-empty-state All stocked items are up to date.
        .es-card
          .es-card__header
            h2 Category Overview
          ul.es-category-list
            each category in categories
              - const categoryData = category_lookup_and_stock[category._id.toString()];
              li(class=`es-category${categoryData && categoryData.percent >= 100 ? ' es-category--ready' : ''}`)
                .es-category__row
                  span.es-category__name #{category.name}
                  if categoryData
                    span.es-category__percent= `${categoryData.percent}%`
                if categoryData
                  .es-category__meta Recommended: #{category.recommendedStock} #{category.unit}
                  .es-category__meta Current: #{categoryData.stock} #{category.unit}
                else
                  .es-category__meta No stock data available.
      .es-dashboard__column
        .es-card
          .es-card__header
            h2 Add Stock Item
            p.es-card__meta Quick add for monthly rotations.
          form#add-item-form(action='/es/add_item', method='post')
            label(for='add_category_id') Select category
            select#add_category_id.form-select(name='add_category_id', required)
              each category in categories
                option(value=category._id)= `${category.name} (${category.unit})`
            label(for='amount') Amount
            input#amount.form-control(type='number', name='amount', min='0', step='1', required)
            label(for='rotateDate') Date (only year and month are used)
            input#rotateDate.form-control(type='date', name='rotateDate', required)
            label(for='label') Label (optional)
            input#label.form-control(type='text', name='label', placeholder='e.g., Brand or package detail')
            button.es-button.es-button--primary(type='submit') Add Item
        details.es-card.es-card--collapsible
          summary
            span.es-card__header
              span Manage Categories
              span.es-card__meta Rarely used
          form(action='/es/edit_category', method='post')
            label(for='category_id') Select category to edit
            select#category_id.form-select(name='category_id')
              option(value='') New category
              each category in categories
                option(value=category._id)= category.name
            label(for='name') Category name
            input#name.form-control(type='text', name='name', placeholder='e.g., Canned beans')
            label(for='recommendedStock') Recommended stock
            input#recommendedStock.form-control(type='number', name='recommendedStock', min='0', step='1')
            label(for='unit') Unit
            input#unit.form-control(type='text', name='unit', placeholder='e.g., cans')
            label(for='rotationPeriodMonths') Rotation period in months
            input#rotationPeriodMonths.form-control(type='number', name='rotationPeriodMonths', min='1', step='1')
            button.es-button.es-button--primary(type='submit') Save Category

block script
  script(src='/js/es_dashboard.js', defer)
