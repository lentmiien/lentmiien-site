extends layout

mixin tile(href, src, alt, label)
  a.mypage-tile(href=href)
    .img-card
      .img-card__inner
        img.mypage-img(src=src, alt=alt)
        span.img-card__label= label

block styles
  link(rel="stylesheet", href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap")
  style.
    :root {
      --life-log-ink: #1f1a16;
      --life-log-muted: #6c5c4d;
      --life-log-accent: #d05c33;
      --life-log-accent-2: #2f8f83;
      --life-log-surface: #fff8f0;
      --life-log-surface-strong: #f6efe6;
      --life-log-border: #e4d8cc;
      --life-log-chip: #fff1e3;
    }

    .life-log-shell {
      font-family: 'Space Grotesk', 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top right, rgba(47, 143, 131, 0.12), transparent 40%),
        radial-gradient(circle at 20% 10%, rgba(208, 92, 51, 0.12), transparent 45%),
        linear-gradient(135deg, #fff8f0 0%, #f3e8da 100%);
      border: 1px solid var(--life-log-border);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 24px 60px rgba(31, 26, 22, 0.08);
      color: var(--life-log-ink);
      animation: life-log-shell-in 0.5s ease both;
    }

    .life-log-details {
      font-family: 'Space Grotesk', 'Segoe UI', sans-serif;
    }

    .life-log-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      width: 100%;
      padding: 0.85rem 1.1rem;
      border: 1px solid var(--life-log-border);
      border-radius: 18px;
      background: linear-gradient(120deg, #fff8f0 0%, #f7ede1 60%, #eef6f4 100%);
      color: var(--life-log-ink);
      cursor: pointer;
      list-style: none;
      user-select: none;
      box-shadow: 0 14px 28px rgba(31, 26, 22, 0.08);
      font-weight: 600;
    }

    .life-log-toggle::-webkit-details-marker {
      display: none;
    }

    .life-log-toggle::marker {
      content: '';
    }

    .life-log-toggle-title {
      font-size: 1.05rem;
      letter-spacing: -0.01em;
    }

    .life-log-toggle-hint {
      font-size: 0.85rem;
      color: var(--life-log-muted);
      font-weight: 500;
      white-space: nowrap;
    }

    .life-log-toggle-hint::before {
      content: 'Expand';
    }

    .life-log-details[open] .life-log-toggle-hint::before {
      content: 'Collapse';
    }

    .life-log-toggle::after {
      content: '+';
      border: 1px solid var(--life-log-border);
      border-radius: 999px;
      width: 1.6rem;
      height: 1.6rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      color: var(--life-log-accent);
      font-weight: 600;
      flex-shrink: 0;
    }

    .life-log-details[open] .life-log-toggle::after {
      content: '-';
    }

    .life-log-details[open] .life-log-toggle {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      border-bottom: none;
    }

    .life-log-details[open] .life-log-shell {
      border-top-left-radius: 0;
      border-top-right-radius: 0;
      border-top: none;
    }

    .life-log-header h2 {
      margin-bottom: 0.2rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .life-log-header p {
      margin-bottom: 0;
      color: var(--life-log-muted);
      max-width: 720px;
    }

    .life-log-panel {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--life-log-border);
      border-radius: 16px;
      padding: 1.25rem;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.5);
    }

    .life-log-panel + .life-log-panel {
      margin-top: 1rem;
    }

    .life-log-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--life-log-muted);
      font-weight: 600;
    }

    .life-log-input,
    .life-log-panel textarea,
    .life-log-panel select {
      border-radius: 10px;
      border: 1px solid var(--life-log-border);
      padding: 0.55rem 0.7rem;
      font-size: 0.95rem;
      background: #fff;
      width: 100%;
    }

    .life-log-input:focus,
    .life-log-panel textarea:focus,
    .life-log-panel select:focus {
      border-color: var(--life-log-accent);
      box-shadow: 0 0 0 0.15rem rgba(208, 92, 51, 0.15);
    }

    .life-log-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .life-log-chip {
      border: 1px solid var(--life-log-border);
      background: var(--life-log-chip);
      color: var(--life-log-ink);
      padding: 0.3rem 0.65rem;
      border-radius: 999px;
      font-size: 0.85rem;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .life-log-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(31, 26, 22, 0.12);
    }

    .life-log-actions .btn {
      border-radius: 999px;
      font-weight: 600;
    }

    .life-log-visual {
      background: #fff;
      border-radius: 16px;
      border: 1px solid var(--life-log-border);
      padding: 1rem;
    }

    .life-log-visual-canvas {
      position: relative;
      width: 100%;
      max-width: 420px;
      aspect-ratio: 3 / 2;
      margin: 0 auto;
      background: #f1e6d8;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--life-log-border);
    }

    .life-log-visual-canvas img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: contrast(1.05) saturate(0.95);
      user-select: none;
      pointer-events: none;
    }

    .life-log-visual-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 2;
    }

    .life-log-visual-overlay .point {
      position: absolute;
      border-radius: 50%;
      border-style: solid;
      transform: translate(-50%, -50%);
      box-sizing: border-box;
    }

    .life-log-visual-overlay .point.selected {
      box-shadow: 0 0 0 2px rgba(208, 92, 51, 0.35);
    }

    .life-log-point-list {
      border: 1px solid var(--life-log-border);
      border-radius: 12px;
      max-height: 180px;
      overflow: auto;
      background: #fffdfa;
    }

    .life-log-point-list .point-item,
    .life-log-point-list .point-item-add {
      padding: 0.45rem 0.75rem;
      display: flex;
      gap: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid var(--life-log-border);
      font-size: 0.88rem;
    }

    .life-log-point-list .point-item:last-child {
      border-bottom: none;
    }

    .life-log-point-list .point-item.selected,
    .life-log-point-list .point-item-add.selected {
      background: #f8eadd;
    }

    .life-log-point-list .point-item-add {
      font-weight: 600;
      color: var(--life-log-accent-2);
    }

    .cat-dot {
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
      border: 2px solid #0003;
      display: inline-block;
      flex-shrink: 0;
    }

    .life-log-status {
      font-size: 0.85rem;
      color: var(--life-log-muted);
    }

    @media (max-width: 992px) {
      .life-log-shell {
        padding: 1rem;
      }
    }

    @keyframes life-log-shell-in {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

block content
  .row 
    a(href='/scheduleTask/upcoming')
      .col 
        - let noTasks = true
        each t in tasks 
          if !t.done && t.type === "todo"
            - noTasks = false
            span.badge.schedule-task-pill.schedule-task-pill--todo= `${t.title} in ${t.start && t.start.getTime() > Date.now() ? Math.round((t.start.getTime() - Date.now()) / (1000*60*60)) : t.end && t.end.getTime() > Date.now() ? Math.round((t.end.getTime() - Date.now()) / (1000*60*60)) : 0} hour(s)`
        each t in tasks 
          if !t.done && t.type === "tobuy"
            - noTasks = false
            span.badge.schedule-task-pill.schedule-task-pill--tobuy= t.title
        if noTasks
          span.badge.schedule-task-pill.schedule-task-pill--empty Show all tasks
  .row.mb-4
    .col
      form.card.card-body(action="/mypage/embedding-search", method="get")
        .d-flex.flex-column.flex-md-row.align-items-md-center.gap-3
          .flex-grow-1.w-100
            label.form-label(for="mypage_search_query") Search stored embeddings
            input#mypage_search_query.form-control(type="text", name="query", placeholder="Search OCR, chat, knowledge, and more", required)
            input(type="hidden", name="top_k", value="50")
            small.form-text.text-muted Opens the embedding search page with up to 50 results.
          .d-flex.flex-column.flex-md-row.align-items-md-center.gap-2
            label.form-label.mb-0(for="mypage_search_type") Mode
            select#mypage_search_type.form-select(name="search_type", style="min-width:180px;")
              if embeddingSearchTypes && embeddingSearchTypes.length
                each option in embeddingSearchTypes
                  option(value=option.value, selected=(embeddingSearchDefaultType && embeddingSearchDefaultType === option.value))= option.label
              else
                option(value="default" selected) Fast (default)
                option(value="high_quality") High-quality model
                option(value="combined") Combined (rerank with high-quality)
            button.btn.btn-primary(type="submit") Search
  .row.mb-4
    .col
      details#life-log-details.life-log-details
        summary.life-log-toggle
          span.life-log-toggle-title My Life Log
          span.life-log-toggle-hint
        .life-log-shell
          - const lifeLog = lifeLogSuggestions || {};
          - const lifeLogLabels = lifeLog.all || [];
          .d-flex.flex-column.flex-lg-row.justify-content-between.gap-3.align-items-start.life-log-header.mb-3
            div
              h2.mb-1 My Life Log
              p.mb-0 Quick entries, diary notes, and body-map visual logs. View the timeline anytime.
            a.btn.btn-outline-dark.btn-sm.mt-1(href="/mypage/life_log") View timeline
          .row.g-4
            .col-lg-5
              .life-log-panel
                form#life-log-form
                  .d-flex.flex-column.gap-3
                    .d-flex.flex-column
                      span.life-log-label Type
                      select#life-log-type.life-log-input(name="type")
                        option(value="basic") Basic
                        option(value="medical") Medical
                        option(value="diary") Diary
                    .d-flex.flex-column
                      span.life-log-label Label
                      input#life-log-label.life-log-input(type="text", name="label", list="life-log-labels", placeholder="e.g. Vitamin C, Mood, Work")
                      datalist#life-log-labels
                        each label in lifeLogLabels
                          option(value=label)
                    .d-flex.flex-column#life-log-value-row
                      span.life-log-label Value
                      input#life-log-value.life-log-input(type="text", name="value", placeholder="e.g. 1, yes, 20 min")
                    .d-flex.flex-column#life-log-text-row(style="display:none;")
                      span.life-log-label Diary text
                      textarea#life-log-text.life-log-input(rows="5", placeholder="Add a short note...")
                      .d-flex.flex-column.gap-2.mt-2
                        label.life-log-label(for="life-log-audio") Transcribe audio
                        input#life-log-audio.form-control(type="file", accept="audio/*")
                        button#life-log-transcribe.btn.btn-outline-secondary.btn-sm(type="button") Transcribe audio
                        button#life-log-format.btn.btn-outline-dark.btn-sm(type="button") Polish text with AI
                    .d-flex.flex-column
                      span.life-log-label Timestamp
                      input#life-log-timestamp.life-log-input(type="datetime-local", name="timestamp")
                    .life-log-actions.d-flex.flex-wrap.gap-2
                      button#life-log-save.btn.btn-dark(type="submit") Save entry
                    .life-log-status#life-log-status Ready.
                if lifeLog.top && lifeLog.top.length
                  .mt-4
                    .life-log-label.mb-2 Top labels
                    .life-log-chips
                      each label in lifeLog.top
                        button.life-log-chip(type="button", data-label=label)= label
                if lifeLog.timeOfDay && lifeLog.timeOfDay.length
                  .mt-3
                    .life-log-label.mb-2 Suggested for now
                    .life-log-chips
                      each label in lifeLog.timeOfDay
                        button.life-log-chip(type="button", data-label=label)= label
                if lifeLog.recent && lifeLog.recent.length
                  .mt-3
                    .life-log-label.mb-2 Recently used
                    .life-log-chips
                      each label in lifeLog.recent
                        button.life-log-chip(type="button", data-label=label)= label
            .col-lg-7
              .life-log-panel
                .d-flex.justify-content-between.align-items-start.mb-3
                  div
                    h4.mb-1 Visual log
                    p.text-muted.mb-0 Tap the body map to place points for pain or discomfort.
                  span.life-log-label Visual log entry
                .life-log-visual
                  #llv-img-wrap.life-log-visual-canvas
                    img#llv-img(src="/i/img_select.jpg", alt="Body map", draggable="false")
                    #llv-points-overlay.life-log-visual-overlay
                    #llv-img-hitbox(style="position:absolute;inset:0;z-index:5;cursor:crosshair;")
                  .row.mt-3.g-3
                    .col-md-6
                      .d-flex.flex-column.gap-2
                        label.life-log-label(for="llv-radius") Point radius
                        input#llv-radius.form-range(type="range", min="2", max="28", value="8")
                        div#llv-radius-val.life-log-status 8 px
                    .col-md-6
                      .d-flex.flex-column.gap-2
                        label.life-log-label(for="llv-opacity") Intensity
                        input#llv-opacity.form-range(type="range", min="25", max="100", value="80")
                        div#llv-opacity-val.life-log-status 80%
                  .row.mt-3.g-3
                    .col-md-6
                      .d-flex.flex-column.gap-2
                        label.life-log-label(for="llv-category") Category
                        select#llv-category.form-select
                    .col-md-6
                      .d-flex.flex-column.gap-2
                        label.life-log-label(for="llv-timestamp") Timestamp
                        input#llv-timestamp.form-control(type="datetime-local")
                  #llv-point-list.life-log-point-list.mt-3
                  .d-flex.flex-wrap.gap-2.mt-3
                    button#llv-save.btn.btn-dark(type="button") Save visual log
                    button#llv-clear.btn.btn-outline-secondary(type="button") Clear
                    button#llv-delete.btn.btn-outline-danger(type="button" disabled) Delete point
                  .life-log-status.mt-2#llv-status Ready.
  .row 
    .col 
      .mypage-grid
        +tile('/mypage/life_log', '/i/health.jpg', 'life log', 'My Life Log')
        +tile('/mypage/blogpost', '/i/blog.jpg', 'blogpost', 'Write blog')
        if permissions && permissions.indexOf("accounting") >= 0
          +tile('/accounting', '/i/budget.jpg', 'accounting', 'Accounting')
        if permissions && permissions.indexOf("chat5") >= 0
          +tile('/chat5/top', '/i/chat5.jpg', 'chat5', 'Chat 5')
        if permissions && permissions.indexOf("chat4") >= 0
          +tile('/chat4/knowledgelist', '/i/knowledge.jpg', 'knowledge', 'Knowledge')
        if permissions && permissions.indexOf("cooking") >= 0
          +tile('/cooking/v2', '/i/calendar.jpg', 'cooking calendar', 'Cooking calendar')
        +tile('/chat4/batch_status', '/i/batch.jpg', 'batch', 'Batch')
        +tile('/', '/i/vueapp.jpg', 'vue app', 'VUE app')
        +tile('/mypage/pdf_to_jpg', '/i/pdfconv.jpg', 'PDF to image converter', 'PDF to Image')
        if permissions && permissions.indexOf("ocr") >= 0
          +tile('/ocr', '/i/receipt.jpg', 'ocr tool', 'OCR tool')
          +tile('/ocr-tts', '/i/receipt.jpg', 'ocr → tts', 'OCR → TTS queue')
        if permissions && permissions.indexOf("product") >= 0
          +tile('/product', '/i/product.jpg', 'Product details', 'Product details')
        if permissions && permissions.indexOf("gallery") >= 0
          +tile('/gallery', '/i/gallery.jpg', 'Gallery', 'Gallery')
        if permissions && permissions.indexOf("payroll") >= 0
          +tile('/payroll', '/i/payroll.jpg', 'Payroll', 'Payroll')
        if permissions && permissions.indexOf("emergencystock") >= 0
          +tile('/es/es_dashboard', '/i/stock.jpg', 'Emergency stock', 'Emergency stock')
        if permissions && permissions.indexOf("scheduletask") >= 0
          +tile('/scheduleTask/calendar', '/i/schedule.jpg', 'Calendar', 'Calendar')
        if permissions && permissions.indexOf("image_gen") >= 0
          +tile('/image_gen', '/i/img_gen.jpg', 'Generate and edit images', 'Image Gen')
          +tile('/image_gen/bulk', '/i/img_gen_bulk.jpg', 'Generate and edit images in batches', 'Image Gen bulk')
        if permissions && permissions.indexOf("music") >= 0
          +tile('/music', '/i/music.jpg', 'AI music library', 'Music')
        if permissions && permissions.indexOf("sora") >= 0
          +tile('/sora', '/i/vid_gen.jpg', 'Generate and edit short videos', 'Video Gen')
        if permissions && permissions.indexOf("budget") >= 0
          +tile('/budget/cards', '/i/credit.jpg', 'Credit Card usage', 'Credit Card')
        if permissions && permissions.indexOf("shoppinglist") >= 0
          +tile('/shopping-list', '/i/shopping.jpg', 'Shopping list', 'Shopping list')
  if new_openai_models.length > 0
    .row 
      .col
        h3.mypage-section-title New OpenAI models (last 30 days)
        each m in new_openai_models
          - const openaiCreatedDate = (new Date(m.created*1000)).toDateString()
          span.model-tag.model-tag--openai
            if m.existsInDb
              span= `${m.model} (${openaiCreatedDate})`
              span.model-tag__status(title="Already saved in AI model cards")= ' - saved'
            else
              a(href=m.manageUrl)= `${m.model} (${openaiCreatedDate})`
              span.model-tag__status(title="Not saved in AI model cards - click to add")= ' - missing'
  if new_anthropic_models.length > 0
    .row 
      .col
        h3.mypage-section-title New Anthropic models (last 30 days)
        each m in new_anthropic_models
          - const anthropicCreatedDate = (new Date(m.created*1000)).toDateString()
          span.model-tag.model-tag--anthropic
            if m.existsInDb
              span= `${m.model} (${anthropicCreatedDate})`
              span.model-tag__status(title="Already saved in AI model cards")= ' - saved'
            else
              a(href=m.manageUrl)= `${m.model} (${anthropicCreatedDate})`
              span.model-tag__status(title="Not saved in AI model cards - click to add")= ' - missing'

block script
  script(src="/js/my_life_log.js")
