//- views/image_gen/bulk_job.pug
extends ../layout

block styles
  style.
    .panel{background:var(--surface-1);color:var(--text);border:1px solid var(--border);border-radius:1rem;padding:1.5rem;margin-bottom:1.5rem;box-shadow:0 20px 48px rgba(0,0,0,0.28)}
    .panel h2{font-size:1.05rem;margin-bottom:1rem;color:var(--text)}
    .status-pill{display:inline-flex;align-items:center;padding:.3rem .75rem;border-radius:999px;border:1px solid var(--divider);background:var(--surface-2);color:var(--text-secondary);font-size:.72rem;letter-spacing:.08em;text-transform:uppercase}
    .progress-wrap{margin:1rem 0}
    .progress{height:.5rem;border-radius:1rem;background:var(--surface-2);overflow:hidden}
    .progress-bar{background:linear-gradient(90deg,var(--brand),var(--accent))}
    .matrix-scroll{overflow-x:auto;padding-bottom:1rem}
    .matrix-table{min-width:640px;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:1rem;overflow:hidden;background:var(--surface-1)}
    .matrix-table th,.matrix-table td{padding:.75rem;border-bottom:1px solid var(--divider);border-right:1px solid var(--divider);color:var(--text);background:var(--surface-1);vertical-align:top}
    .matrix-table thead th{background:var(--surface-2);color:var(--text-secondary);text-transform:uppercase;font-size:.75rem;letter-spacing:.06em}
    .matrix-table tr:last-child td{border-bottom:none}
    .matrix-table th:last-child,.matrix-table td:last-child{border-right:none}
    .matrix-cell{display:flex;flex-direction:column;gap:.75rem;min-width:220px}
    .matrix-cell .avg{font-size:.85rem;color:var(--text-muted)}
    .matrix-table th .avg{display:block;font-size:.75rem;color:var(--text-muted);text-transform:none;margin-top:.25rem;font-weight:400;letter-spacing:0}
    .matrix-cell .thumb-grid{display:grid;gap:.5rem;grid-template-columns:repeat(auto-fit,minmax(96px,1fr))}
    .matrix-thumb{display:flex;flex-direction:column;gap:.45rem;background:var(--surface-2);border:1px solid var(--divider);border-radius:.75rem;padding:.6rem;text-decoration:none;color:inherit}
    .matrix-thumb-media{width:100%;border-radius:.5rem;border:1px solid var(--border);background:var(--surface-1);max-height:160px;object-fit:cover}
    .matrix-thumb-media--empty{display:flex;align-items:center;justify-content:center;min-height:120px;border:1px dashed var(--divider);color:var(--text-muted)}
    .matrix-thumb-badge{display:inline-flex;align-items:center;align-self:flex-start;padding:.15rem .55rem;border-radius:999px;font-size:.65rem;letter-spacing:.08em;text-transform:uppercase;background:var(--surface-3);color:var(--accent);border:1px solid var(--accent)}
    .matrix-thumb-badge--video{background:var(--brand-tint);color:var(--brand);border-color:var(--brand)}
    .matrix-thumb-badge--gif{background:var(--accent-tint);color:var(--accent);border-color:var(--accent)}
    .matrix-thumb .meta{font-size:.75rem;color:var(--text-secondary)}
    .prompt-table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:1rem;overflow:hidden;background:var(--surface-1)}
    .prompt-table th,.prompt-table td{padding:.6rem;border-bottom:1px solid var(--divider);color:var(--text)}
    .prompt-table th{background:var(--surface-2);text-transform:uppercase;font-size:.75rem;letter-spacing:.05em;color:var(--text-secondary)}
    .prompt-table tr:last-child td{border-bottom:none}
    .auto-refresh-note{font-size:.85rem;color:var(--text-muted)}
    .text-soft{color:var(--text-muted)}
    .text-soft{color:var(--text-muted)}
    .gallery-filter{background:var(--surface-1);border:1px solid var(--border);border-radius:1rem;padding:1rem}
    .gallery-filter .form-select{background:var(--surface-1);color:var(--text)}
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem}
    .gallery-card{display:flex;flex-direction:column;gap:.6rem;background:var(--surface-2);border:1px solid var(--divider);border-radius:.75rem;padding:.75rem}
    .gallery-media{width:100%;border-radius:.5rem;border:1px solid var(--border);object-fit:cover;max-height:240px;background:var(--surface-1)}
    .gallery-media--video{object-fit:contain}
    .gallery-meta{font-size:.75rem;color:var(--text-secondary);display:flex;flex-direction:column;gap:.35rem}
    .gallery-meta .tag{display:inline-flex;align-items:center;gap:.3rem;background:var(--surface-3);border:1px solid var(--divider);border-radius:999px;padding:.2rem .6rem;font-size:.65rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted)}
    .gallery-summary{font-size:.85rem;color:var(--text-muted)}
    .gallery-rating-controls .btn{min-width:72px}

block content
  .container.py-4#jobRoot(data-job-id=jobId)
    a.text-decoration-none.text-soft(href="/image_gen/bulk") Back to bulk jobs
    .d-flex.flex-wrap.justify-content-between.align-items-center.mt-2.mb-3
      div
        h1.h4.mb-2 Job detail
        span#jobStatusPill.status-pill unknown
      .d-flex.gap-2.flex-wrap
        button#startBtn.btn.btn-success.btn-sm(type="button") Start
        button#pauseBtn.btn.btn-warning.btn-sm(type="button") Pause
        button#resumeBtn.btn.btn-primary.btn-sm(type="button") Resume
        button#cancelBtn.btn.btn-outline-danger.btn-sm(type="button") Cancel
        button#redoBtn.btn.btn-outline-info.btn-sm(type="button") Redo canceled prompts
        a.btn.btn-outline-info.btn-sm(href=`/image_gen/bulk/${jobId}/slideshow`) Slideshow rating
        a.btn.btn-outline-primary.btn-sm(href=`/image_gen/bulk/${jobId}/analytics`) Performance analytics
    .panel
      h2 Overview
      .row.g-3
        .col-md-6
          dl.row.mb-0
            dt.col-5 Name
            dd.col-7#jobName -
            dt.col-5 Workflow
            dd.col-7#jobWorkflow -
            dt.col-5 Created
            dd.col-7#jobCreated -
            dt.col-5 Updated
            dd.col-7#jobUpdated -
        .col-md-6
          .progress-wrap
            label.form-label Progress
            .progress
              .progress-bar#jobProgress(style="width:0%")
            small.auto-refresh-note#jobProgressLabel 0 / 0 completed
          dl.row.mb-0
            dt.col-5 Started
            dd.col-7#jobStarted -
            dt.col-5 Completed
            dd.col-7#jobCompleted -
      hr
      h2.mb-2 Counts
      ul#jobCounts.list-unstyled.mb-0
    .panel
      .d-flex.flex-wrap.gap-2.align-items-center.mb-3
        h2.mb-0 Comparison matrix
        span.auto-refresh-note Matrix auto-refreshes while job is processing.
      if !jobId
        p.text-soft Invalid job id.
      else
        .row.g-3.align-items-end
          .col-md-4
            label.form-label(for="varSelectA") Variable A
            select#varSelectA.form-select
          .col-md-4
            label.form-label(for="varSelectB") Variable B
            select#varSelectB.form-select
          .col-md-4
            button#refreshMatrixBtn.btn.btn-outline-secondary.btn-sm(type="button") Refresh matrix
        .matrix-scroll.mt-3
          #matrixArea
    .panel
      .d-flex.justify-content-between.align-items-center.mb-2.flex-wrap.gap-2
        h2.mb-0 Variant gallery
        span.auto-refresh-note Select filters and submit to view up to 25 items. Leave blank to see the top rated combinations.
      form#galleryFilterForm.gallery-filter
        #galleryFilterFields.row.g-3
        .d-flex.gap-2.flex-wrap.mt-3
          button#galleryApplyBtn.btn.btn-outline-secondary.btn-sm(type="submit") Show images
          button#galleryResetBtn.btn.btn-link.btn-sm(type="button") Clear filters
      #gallerySummary.gallery-summary.mt-2
      #galleryResults.mt-3
        .text-soft#galleryLoading(style="display:none") Loading images…
        .text-soft#galleryEmpty(style="display:none") No images match the current filters yet.
        .text-danger#galleryError(style="display:none")
        #galleryGrid.gallery-grid
      form#galleryRateForm.mt-3
        fieldset.border-0.p-0.m-0.gallery-rating-controls.d-none#galleryRatingControls
          legend.visually-hidden Rate shown images
          .d-flex.flex-wrap.align-items-center.gap-3
            span.fw-semibold Rate shown images:
            .btn-group(role="group" aria-label="Rate images")
              input#galleryRatingGood.btn-check(type="radio" name="galleryRating" value="good")
              label.btn.btn-outline-success(for="galleryRatingGood") Good
              input#galleryRatingNeutral.btn-check(type="radio" name="galleryRating" value="neutral")
              label.btn.btn-outline-secondary(for="galleryRatingNeutral") Neutral
              input#galleryRatingBad.btn-check(type="radio" name="galleryRating" value="bad")
              label.btn.btn-outline-danger(for="galleryRatingBad") Bad
            button#galleryRateSubmitBtn.btn.btn-primary.btn-sm(type="submit") Submit rating
            button#galleryRateCancelBtn.btn.btn-link.btn-sm(type="button") Cancel
    .panel
      h2 Prompts
      .d-flex.justify-content-between.align-items-center.mb-2
        span.auto-refresh-note Showing up to 200 prompts
        button#refreshPromptsBtn.btn.btn-outline-secondary.btn-sm(type="button") Refresh
      .table-responsive
        table.prompt-table
          thead
            tr
              th(scope="col") Template
              th(scope="col") Placeholders
              th(scope="col") Negative?
              th(scope="col") Status
              th(scope="col") Score
              th(scope="col") Updated
          tbody#promptTableBody

block script
  script(src="/js/image_gen_bulk_job.js")
