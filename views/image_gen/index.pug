//- views/image_gen/index.pug
extends ../layout

block styles
  style.
    .imgen-page .card{background:var(--surface-1);border:1px solid var(--border);color:var(--text);box-shadow:0 18px 40px rgba(0,0,0,0.26);border-radius:1rem}
    .imgen-page .card h2{color:var(--text);letter-spacing:.04em;text-transform:uppercase;font-size:.8rem}
    .imgen-page .form-label{color:var(--text-secondary);font-weight:600;letter-spacing:.02em}
    .muted{color:var(--text-muted)}
    .thumb{position:relative;background:var(--surface-1);border:1px solid var(--border);border-radius:.75rem;padding:.75rem;box-shadow:0 16px 32px rgba(0,0,0,0.22);overflow:hidden}
    .thumb-media{width:100%;border-radius:.5rem;border:1px solid var(--divider);background:var(--surface-2);max-height:420px;display:block;object-fit:contain}
    .thumb-media--empty{display:flex;align-items:center;justify-content:center;min-height:160px;border:1px dashed var(--divider);color:var(--text-muted);font-size:.85rem}
    .thumb-video .thumb-media{background:#000}
    .media-badge{position:absolute;top:.75rem;right:.75rem;padding:.2rem .6rem;border-radius:999px;font-size:.65rem;letter-spacing:.08em;text-transform:uppercase;background:var(--surface-3);color:var(--accent);border:1px solid var(--accent)}
    .media-badge--video{background:var(--brand-tint);color:var(--brand);border-color:var(--brand)}
    .media-badge--gif{background:var(--accent-tint);color:var(--accent);border-color:var(--accent)}
    .thumb .btn{margin-top:.6rem}
    .monospace{font-family:'JetBrains Mono','Fira Code',monospace;font-size:.85rem}
    .log{background:var(--surface-1);color:var(--text);border:1px solid var(--border);border-radius:.75rem;padding:.75rem;max-height:220px;overflow:auto}
    .pill{display:inline-flex;align-items:center;padding:.25rem .75rem;border-radius:999px;background:var(--surface-2);border:1px solid var(--divider);font-size:.72rem;letter-spacing:.08em;text-transform:uppercase;color:var(--text-secondary);margin-left:.75rem}
    #statusPill{border-color:var(--accent);background:var(--accent-tint);color:var(--accent)}
    .browse-actions{display:flex;gap:.5rem;flex-wrap:wrap}
    .browse-grid{margin-top:.75rem}
    .browse-actions button{min-width:0}
    #promptModal{z-index:99999;}
    .workflow-field{border:1px solid var(--divider);background:var(--surface-2);border-radius:.75rem;padding:.75rem}
    .workflow-field__title{font-weight:700;letter-spacing:.01em}
    .workflow-field__meta{color:var(--text-muted);font-size:.85rem}
    #workflowJson{font-family:'JetBrains Mono','Fira Code',monospace;font-size:.85rem}

block content
  .container.py-3.imgen-page
    .d-flex.align-items-center.mb-3
      h1.h4.mb-0 ComfyUI Image &amp; Video Studio
      span#statusPill.pill idle
      a.btn.btn-outline-primary.btn-sm.ms-auto(href="/image_gen/good") Saved gallery

    // Gateway
    .card.mb-3
      .card-body
        .d-flex.justify-content-between.align-items-center.mb-2
          h2.h6.mb-0 Gateway
          button#btnHealth.btn.btn-outline-secondary.btn-sm(type="button") Check health
        .d-flex.align-items-center.gap-2
          span#healthDot.badge.bg-secondary unknown
          small#instanceMeta.text-muted

    // Workflows
    .card.mb-3
      .card-body
        .d-flex.justify-content-between.align-items-center.mb-2
          h2.h6.mb-0 Workflows
          .d-flex.gap-2
            button#btnViewJson.btn.btn-outline-secondary.btn-sm(type="button" data-bs-toggle="modal" data-bs-target="#jsonModal") View JSON
            button#btnLoadWf.btn.btn-primary.btn-sm(type="button") Reload list
        .row.g-3.align-items-end
          .col-md-8
            label.form-label(for="wfSelect") Select workflow
            select#wfSelect.form-select
          .col-md-4
            small#wfCount.text-muted 0 loaded
        .mt-3
          label.form-label(for="nodeFieldSelect") Customize workflow inputs
          select#nodeFieldSelect.form-select(disabled aria-describedby="fieldHelp")
          small#fieldHelp.text-muted Select a node + value to expose an input; only fields with values are listed.
        .row.g-2.mt-2
          .col-md-8
            .form-check.mb-0
              input#fieldAsPrompt.form-check-input(type="checkbox")
              label.form-check-label(for="fieldAsPrompt") Use as prompt (textarea; used for rating/embeddings)
          .col-md-4.text-md-end
            button#btnMakeEditable.btn.btn-outline-primary(type="button") Make editable
        #editableFields.mt-3
        .row.g-3.mt-3
          .col-md-6
            label.form-label(for="promptText") Prompt (rating/embeddings)
            textarea#promptText.form-control(rows="2" readonly placeholder="Select a prompt field above")
          .col-md-6
            label.form-label(for="negativeText") Negative prompt (optional)
            input#negativeText.form-control(type="text" autocomplete="off")
        .d-flex.gap-2.mt-3
          button#btnGenerate.btn.btn-success(type="button") Generate

    // Jobs
    .card.mb-3
      #job_card_body.card-body
        h2.h6 Job
        .row.g-3.align-items-end
          .col-md-6
            label.form-label(for="jobId") Job ID
            input#jobId.form-control(type="text" readonly)
          .col-md-6
            .d-flex.align-items-center.gap-2
              button#btnPoll.btn.btn-outline-secondary(type="button") Poll
              span#jobStatus.badge.bg-secondary -
        .row.row-cols-2.row-cols-md-3.g-3.mt-2#results

    // Log
    .card
      .card-body
        h2.h6 Log
        .log#log

    #promptModal.modal.fade(tabindex='-1' aria-hidden='true')
      .modal-dialog.modal-lg
        .modal-content
          .modal-header
            h5.modal-title Prompt library
            button.btn-close(type='button' data-bs-dismiss='modal' aria-label='Close')
          .modal-body
            .d-flex.justify-content-between.align-items-center.mb-2
              ul.nav.nav-tabs(role='tablist')
                li.nav-item
                  button#tabPos.nav-link.active(type='button' role='tab') Positive
                li.nav-item
                  button#tabNeg.nav-link(type='button' role='tab') Negative
              .form-check.form-switch
                input#libShowAll.form-check-input(type='checkbox')
                label.form-check-label(for='libShowAll') Show all
            .mb-3
              input#promptFilter.form-control.form-control-sm(type='search' placeholder='Filter prompts...' autocomplete='off')
            // List
            .list-group#promptList(style='max-height: 420px; overflow:auto;')
          .modal-footer
            button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Close

    #jsonModal.modal.fade(tabindex='-1' aria-hidden='true')
      .modal-dialog.modal-xl
        .modal-content
          .modal-header
            h5.modal-title Workflow JSON (read-only)
            button.btn-close(type='button' data-bs-dismiss='modal' aria-label='Close')
          .modal-body
            textarea#workflowJson.form-control.monospace(rows='18' spellcheck='false' readonly)
          .modal-footer
            button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Close

block script
  //- Serve this file from /public/js/image_gen.js
  script(src="/js/image_gen.js")
