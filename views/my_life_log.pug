extends layout

block styles
  link(rel="stylesheet", href="/css/my_life_log.css")

block content
  .life-log-page
    .life-log-hero
      h1.mb-2 My Life Log Timeline
      p.mb-0 Filter by dates, labels, and types. Newer entries show up first, with legacy health logs merged in.
      a.btn.btn-outline-dark.btn-sm.mt-3(href="/mypage") Back to mypage

    form.life-log-filter(method="get", action="/mypage/life_log")
      .row.g-3
        .col-md-4
          label(for="life-log-start") Start
          input#life-log-start.form-control(type="datetime-local", name="start", value=filters.start)
        .col-md-4
          label(for="life-log-end") End
          input#life-log-end.form-control(type="datetime-local", name="end", value=filters.end)
        .col-md-4
          label(for="life-log-label-input") Labels
          input#life-log-label-input.form-control(type="text", name="labels", placeholder="comma-separated", value=filters.labels, list="life-log-labels")
          datalist#life-log-labels
            each label in labelOptions
              option(value=label)
      .row.g-3.mt-1
        .col-md-8
          label Types
          .d-flex.flex-wrap.gap-3.mt-2
            each option in typeOptions
              - const isChecked = filters.types && filters.types.includes(option.value);
              label.form-check-label
                input.form-check-input(type="checkbox", name="types", value=option.value, checked=isChecked)
                | #{option.label}
        .col-md-4
          label Legacy entries
          .form-check.form-switch.mt-2
            input(type="hidden", name="include_legacy", value="false")
            input.form-check-input(type="checkbox", name="include_legacy", value="true", checked=filters.includeLegacy)
            span.form-check-label Include legacy health logs
      .d-flex.justify-content-end.mt-3
        button.btn.btn-dark(type="submit") Apply filters

    if entries && entries.length
      .life-log-layout-controls
        span.life-log-layout-label View
        .life-log-layout-toggle
          button.life-log-layout-btn.is-active(type="button", data-life-log-layout="timeline", aria-pressed="true") Timeline
          button.life-log-layout-btn(type="button", data-life-log-layout="summary", aria-pressed="false") Daily summary
      .life-log-views(data-layout="timeline")
        .life-log-view.life-log-view--timeline
          .life-log-timeline
            each entry, idx in entries
              .life-log-item.life-log-entry(data-entry-id=entry.id, data-legacy=entry.isLegacy, style=`--delay:${idx}`)
                .life-log-dot
                .life-log-card
                  .life-log-meta
                    span.life-log-type= entry.typeLabel
                    span.life-log-time= entry.displayTimestamp
                    if entry.isLegacy
                      span.life-log-legacy Legacy
                    if !entry.isLegacy
                      button.life-log-delete(type="button", title="Delete entry") &times;
                  if entry.label
                    .life-log-label= entry.label
                  if entry.type === 'basic' || entry.type === 'medical'
                    .life-log-value= entry.value
                  if entry.type === 'diary'
                    pre.life-log-text= entry.text
                  if entry.type === 'visual_log'
                    .visual-log-view(data-vlog=entry.v_log_data)
                      img(src="/i/img_select.jpg", alt="Visual log entry")
                      .visual-log-overlay
        .life-log-view.life-log-view--summary
          .life-log-summary
            each day in dailySummary
              .life-log-day
                .life-log-day-header
                  h2.life-log-day-title= day.displayDate
                .life-log-day-groups
                  each group in day.groups
                    .life-log-day-group
                      .life-log-day-label= group.label
                      ul.life-log-day-items
                        each entry in group.entries
                          li.life-log-day-item.life-log-entry(data-entry-id=entry.id, data-legacy=entry.isLegacy)
                            .life-log-day-item-header
                              span.life-log-day-time= entry.displayTime
                              span.life-log-day-type= entry.typeLabel
                              if entry.isLegacy
                                span.life-log-legacy Legacy
                              if !entry.isLegacy
                                button.life-log-delete(type="button", title="Delete entry") &times;
                            if entry.type === 'basic' || entry.type === 'medical'
                              .life-log-day-value= entry.value
                            if entry.type === 'diary'
                              pre.life-log-text.life-log-day-text= entry.text
                            if entry.type === 'visual_log'
                              .visual-log-view(data-vlog=entry.v_log_data)
                                img(src="/i/img_select.jpg", alt="Visual log entry")
                                .visual-log-overlay
    else
      p.mt-4.text-muted No life log entries found for this range.

block script
  script(src="/js/my_life_log_view.js")
