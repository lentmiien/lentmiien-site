extends layout

block content
  .receipt-edit-page
    h1 Receipt workspace
    p.page-intro Upload additional records, compare the source image, and fine-tune the stored details without leaving the page.
    section.section-card.upload-card
      h2 Upload another receipt
      p.section-subtitle Supported formats: JPEG, PNG, WebP, AVIF, GIF, SVG, TIFF.
      form(action="/receipt/upload_receipt", method="post", enctype="multipart/form-data")
        label(for="imgs") Select receipt image files
        .input-group
          input#imgs.form-control(type="file", name="imgs", multiple)
          input.btn.btn-primary(type="submit", value="Upload")
    section.section-card.review-card
      .section-header
        h2 Review receipt details
        span.receipt-meta Last updated #{new Date(receipt.updatedAt || receipt.date).toLocaleDateString()}
      .view-toggle.js-view-toggle
        button.is-active(type="button", data-panel="image") Receipt image
        button(type="button", data-panel="form") Receipt details
      .view-panels
        .view-panel.active(data-panel="image")
          figure.receipt-image-frame
            img.receipt-image(src=`/img/${receipt.file}`, alt="Receipt preview")
            figcaption Zoom with your browser to inspect the fine print.
        .view-panel(data-panel="form")
          form.receipt-form(action=`/receipt/correct_receipt/${receipt._id.toString()}`, method="post")
            .form-grid
              .form-field
                label(for="date") Date
                input#date.form-control(type="date", name="date", value=receipt.date.toJSON().split('T')[0])
              .form-field
                label(for="amount") Amount
                input#amount.form-control(type="number", name="amount", value=receipt.amount, step="0.01")
              .form-field
                label(for="method") Payment method
                input#method.form-control(type="text", name="method", value=receipt.method)
              .form-field
                label(for="business_name") Business name
                input#business_name.form-control(type="text", name="business_name", value=receipt.business_name)
              .form-field
                label(for="business_address") Business address
                input#business_address.form-control(type="text", name="business_address", value=receipt.business_address)
              .form-field
                label(for="layout_text") Layout text (OCR)
                textarea#layout_text.form-control(name="layout_text", rows="6")= receipt.layout_text || ''
            .form-actions
              input.btn.btn-success(type="submit", value="Update receipt")
          a.btn.btn-secondary(href=`/receipt/add-entry/${receipt._id.toString()}`, target="_blank", rel="noopener") Add to ledger
          a.btn.btn-danger(href=`/receipt/delete_receipt/${receipt._id.toString()}`) Delete
    if test_data
      section.section-card.debug-card
        h2 Debug data
        pre.pretty-json= JSON.stringify(test_data, null, 2)

block script
  script.
    document.addEventListener('DOMContentLoaded', function () {
      var toggleGroup = document.querySelector('.js-view-toggle');
      if (!toggleGroup) {
        return;
      }
      var buttons = toggleGroup.querySelectorAll('button[data-panel]');
      var panels = document.querySelectorAll('.view-panel[data-panel]');
      var activate = function (id) {
        buttons.forEach(function (button) {
          button.classList.toggle('is-active', button.dataset.panel === id);
        });
        panels.forEach(function (panel) {
          panel.classList.toggle('active', panel.dataset.panel === id);
        });
      };
      buttons.forEach(function (button) {
        button.addEventListener('click', function () {
          activate(button.dataset.panel);
        });
      });
      if (buttons.length) {
        var current = Array.prototype.find.call(buttons, function (button) {
          return button.classList.contains('is-active');
        });
        activate((current || buttons[0]).dataset.panel);
      }
    });
