extends layout

block styles
  link(rel='stylesheet', href='/css/aiGateway.css')

block content
  - const errorKeys = Object.keys(dashboard.errors || {}).filter((key) => dashboard.errors[key]);
  - const recentLogs = (dashboard.logs || []).slice(-10).reverse();
  .ai-gateway
    .ai-gateway__header
      .ai-gateway__heading
        h1 AI Gateway
        p.text-muted Monitor gateway health, GPU load, limits, and live logs.
      .ai-gateway__meta
        span.meta-chip Base URL: #{dashboard.baseUrl}
        span.meta-chip Fetched: #{new Date(dashboard.fetchedAt || Date.now()).toLocaleString()}
        a.btn.btn-outline-light.btn-sm(href='/admin/ai-gateway') Refresh

    if errorKeys.length
      .alert.alert-warning(role='alert')
        strong Some endpoints failed to load.
        ul.mb-0
          each key in errorKeys
            li= `${key}: ${dashboard.errors[key]}`

    if dashboard.summaryCards && dashboard.summaryCards.length
      .stat-grid
        each card in dashboard.summaryCards
          .stat-card
            .stat-card__label= card.label
            .stat-card__value= card.value
            if card.helper
              .stat-card__helper= card.helper

    .ai-gateway__grid
      .panel
        .panel__header
          h2.panel__title Request Volume
          p.panel__subtitle Totals per route by HTTP status from /metrics.
        .chart-shell#requestVolumeChart
      .panel
        .panel__header
          h2.panel__title Average Duration
          p.panel__subtitle Mean per-route latency using /metrics histograms.
        .chart-shell#durationChart
      .panel
        .panel__header
          h2.panel__title GPU Utilization
          p.panel__subtitle Busy % and VRAM usage sampled from /gpu.
        .chart-shell#gpuTimelineChart

    .ai-gateway__details
      .panel
        .panel__header
          h2.panel__title Health & Upstreams
          p.panel__subtitle Latest response from /health.
        if dashboard.health && dashboard.health.upstreams && dashboard.health.upstreams.length
          .health-grid
            each upstream in dashboard.health.upstreams
              .health-card(class= upstream.ok ? 'health-card--ok' : 'health-card--fail')
                .health-card__title= upstream.key
                .health-card__status= upstream.ok ? 'OK' : 'Issue'
                if upstream.status
                  .health-card__meta= upstream.status
                if upstream.model
                  .health-card__meta= upstream.model
                if upstream.statusCode
                  .health-card__meta Code: #{upstream.statusCode}
                if upstream.detail
                  .health-card__detail= upstream.detail
        else
          p.text-muted.mb-0 No upstream data available.
      .panel
        .panel__header
          h2.panel__title Limits
          p.panel__subtitle OCR + LLM guardrails from /limits.
        if dashboard.limits
          if dashboard.limits.ocr
            h4.limits-title OCR
            ul.limits-list
              if dashboard.limits.ocr.maxUploadDisplay
                li Max upload: #{dashboard.limits.ocr.maxUploadDisplay}
              if dashboard.limits.ocr.maxPixelsDisplay
                li Max pixels: #{dashboard.limits.ocr.maxPixelsDisplay}
              if dashboard.limits.ocr.maxEdgeDisplay
                li Long edge: #{dashboard.limits.ocr.maxEdgeDisplay}
              if dashboard.limits.ocr.maxTokensDisplay
                li Max new tokens: #{dashboard.limits.ocr.maxTokensDisplay}
              if dashboard.limits.ocr.concurrencyDisplay
                li Concurrency: #{dashboard.limits.ocr.concurrencyDisplay}
              if typeof dashboard.limits.ocr.downscale !== 'undefined'
                li Downscale: #{dashboard.limits.ocr.downscale ? 'On' : 'Off'}
          if dashboard.limits.llm
            h4.limits-title LLM
            if dashboard.limits.llm.defaultModel
              p.text-muted.mb-1 Default model: #{dashboard.limits.llm.defaultModel}
            if dashboard.limits.llm.models && dashboard.limits.llm.models.length
              .models-grid
                each model in dashboard.limits.llm.models
                  .model-card
                    .model-card__name= model.id || model.name
                    if model.maxContextDisplay
                      .model-card__meta Context: #{model.maxContextDisplay} tokens
                    if model.maxOutputDisplay
                      .model-card__meta Output max: #{model.maxOutputDisplay}
                    if typeof model.keep_alive === 'string'
                      .model-card__meta Keep-alive: #{model.keep_alive}
                    if model.allow_images
                      .model-card__badge Allows images
                    else
                      .model-card__badge.model-card__badge--muted Text only
        else
          p.text-muted.mb-0 No limit data available.
      .panel
        .panel__header
          h2.panel__title Recent Logs
          p.panel__subtitle Latest entries from /logs/tail?n=50.
        if recentLogs && recentLogs.length
          .table-responsive
            table.table.table-dark.table-sm.mb-0
              thead
                tr
                  th Timestamp
                  th Route
                  th Status
                  th Duration (s)
                  th Queue (s)
                  th Backend / Model
              tbody
                each entry in recentLogs
                  tr
                    td= entry.isoTime ? entry.isoTime.replace('T', ' ').replace('Z', '') : 'N/A'
                    td= entry.route
                    td= entry.statusCode || 'N/A'
                    td= entry.durationSec !== null && entry.durationSec !== undefined ? entry.durationSec.toFixed(3) : 'N/A'
                    td= entry.queueWaitSec !== null && entry.queueWaitSec !== undefined ? entry.queueWaitSec.toFixed(3) : 'N/A'
                    td
                      if entry.backend
                        span= entry.backend
                      if entry.model
                        span  · #{entry.model}
                      if entry.voiceId
                        span  · #{entry.voiceId}
        else
          p.text-muted.mb-0 No recent logs returned.

block script
  script(src='https://d3js.org/d3.v7.min.js', defer)
  script(type='application/json', id='aiGatewayData') !{JSON.stringify({ baseUrl: dashboard.baseUrl, fetchedAt: dashboard.fetchedAt, chartData: dashboard.chartData, gpu: dashboard.gpu })}
  script(src='/js/aiGateway.js', defer)
