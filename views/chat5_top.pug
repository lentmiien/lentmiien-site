extends layout
block content
  .row.mb-3
    .col 
      h2.mb-0.chat5-title Chat 5 list 
  .row.g-2.align-items-center.mb-3
    .col-md-6
      label(for="filter").form-label.mb-1.chat5-input-label Filter 
      select#filter.form-select(name="filter", onchange="Filter(this)") 
        option(value="") - all -
        each c in sortedCategories
          option(value=c)= c
    .col-md-6.text-md-end.mt-2.mt-md-0
      a.btn.btn-primary.chat5-create-btn(href=`/chat5/chat/NEW`) +NEW

  //- Group headers and cards
  - const now = Date.now()
  - const MIN = 60 * 1000
  - const HOUR = 60 * MIN
  - const DAY = 24 * HOUR
  - const WEEK = 7 * DAY
  - const MONTH = 30 * DAY
  - const YEAR = 365 * DAY
  - const bucketFor = (d) => {
  -   const diff = now - new Date(d).getTime()
  -   if (diff < HOUR) return 'Updated within the last hour'
  -   if (diff < 6 * HOUR) return 'Updated within the last 6 hours'
  -   if (diff < DAY) return 'Updated within the last day'
  -   if (diff < 3 * DAY) return 'Updated within the last 3 days'
  -   if (diff < WEEK) return 'Updated within the last week'
  -   if (diff < 2 * WEEK) return 'Updated within the last 2 weeks'
  -   if (diff < MONTH) return 'Updated within the last month'
  -   if (diff < 3 * MONTH) return 'Updated within the last 3 months'
  -   if (diff < 6 * MONTH) return 'Updated within the last 6 months'
  -   if (diff < YEAR) return 'Updated within the last year'
  -   return 'Updated over a year ago'
  - }
  - const timeAgo = (d) => {
  -   const ms = now - new Date(d).getTime()
  -   if (ms < MIN) return '<1m'
  -   if (ms < HOUR) return Math.floor(ms / MIN) + 'm'
  -   if (ms < DAY) return Math.floor(ms / HOUR) + 'h'
  -   if (ms < WEEK) return Math.floor(ms / DAY) + 'd'
  -   if (ms < MONTH) return Math.floor(ms / WEEK) + 'w'
  -   if (ms < YEAR) return Math.floor(ms / MONTH) + 'mo'
  -   return Math.floor(ms / YEAR) + 'y'
  - }
  - let lastBucket = null

  each c in conversations
    - const b = bucketFor(c.updatedAt)
    if b !== lastBucket
      - lastBucket = b
      .bucket-header.chat5-bucket-header.mt-4.mb-2
        h6.chat5-bucket-title.mb-0= b

    //- Card
    - const tagsStr = (c.tags && c.tags.length) ? c.tags.join(', ') : ''
    - const membersStr = (c.members && c.members.length) ? c.members.join(', ') : ''
    - const msgCount = (c.messages && c.messages.length) ? c.messages.length : 0
    - const createdISO = c.createdAt
    - const updatedISO = c.updatedAt
    .entry.card.entry-card.chat5-entry-card.mb-2(data-category=c.category data-age-bucket=b
      data-title=c.title
      data-summary=(c.summary || '')
      data-category-label=c.category
      data-tags=tagsStr
      data-messages-count=msgCount
      data-members=membersStr
      data-created-iso=createdISO
      data-updated-iso=updatedISO
      data-open-href=`/chat5/chat/${c._id.toString()}`)
      .card-body.py-2.chat5-card-body
        .d-flex.flex-column.flex-md-row.align-items-md-center.justify-content-between.gap-2
          .d-flex.flex-column
            .d-flex.align-items-center.gap-2.flex-wrap
              a.chat5-entry-link.fs-6.fw-semibold(href=`/chat5/chat/${c._id.toString()}`)= `${c.old?"*":""}${c.title}${pending_conversation_ids.indexOf(c._id.toString()) >= 0 ? " [P]" : ""}`
              span.badge.chat5-badge.chat5-badge--category= c.category
            .chat5-entry-meta
              | Updated #{timeAgo(c.updatedAt)} â€¢ #{msgCount} msg#{msgCount === 1 ? '' : 's'}
          .d-flex.align-items-center.gap-2.ms-md-3
            if c.tags && c.tags.length
              //- show first few tags as badges (optional)
              each t, idx in c.tags.slice(0, 3)
                span.badge.chat5-badge.chat5-badge--tag= t
              if c.tags.length > 3
                span.badge.chat5-badge.chat5-badge--tag= `+${c.tags.length - 3}`
            button.btn.btn-outline-secondary.btn-sm(data-preview type="button" data-bs-toggle="modal" data-bs-target="#convPreviewModal") Preview
            a.btn.btn-outline-primary.btn-sm(href=`/chat5/chat/${c._id.toString()}`) Open

  //- Preview Modal
  .modal.fade#convPreviewModal(tabindex="-1" aria-labelledby="convPreviewLabel" aria-hidden="true")
    .modal-dialog.modal-lg.modal-dialog-scrollable.modal-fullscreen-sm-down
      .modal-content
        .modal-header
          h5.modal-title#convPreviewLabel Conversation preview
          button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
        .modal-body.overflow-auto.chat5-preview-body
          h6#previewTitle.mb-2.chat5-preview-title
          p#previewSummary.chat5-preview-summary
          hr.chat5-divider
          .row.row-cols-1.row-cols-md-2.g-3
            .col
              small.chat5-preview-label Category
              div#previewCategory.chat5-preview-value
            .col
              small.chat5-preview-label Tags
              div#previewTags.chat5-preview-value
            .col
              small.chat5-preview-label Messages
              div#previewMessagesCount.chat5-preview-value
            .col
              small.chat5-preview-label Members
              div#previewMembers.chat5-preview-value
            .col
              small.chat5-preview-label Created
              div#previewCreated.chat5-preview-value
            .col
              small.chat5-preview-label Updated
              div#previewUpdated.chat5-preview-value
        .modal-footer
          a.btn.btn-primary#previewOpenLink(href="#") Open conversation
          button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Close
block script
  script(src="/js/chat5_top.js")
