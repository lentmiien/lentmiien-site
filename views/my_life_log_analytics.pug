extends layout

block styles
  link(rel="stylesheet", href="/css/my_life_log.css")

block content
  .life-log-page
    .life-log-hero
      h1.mb-2 Life Log Analytics
      p.mb-0 Explore trends, diary notes, and visual overlays for the selected period.
      .life-log-actions
        a.btn.btn-outline-dark.btn-sm.mt-3(href="/mypage/life_log") Back to life log
    - const basicDefaults = Array.isArray(filters.basicLabels) ? filters.basicLabels : [];
    - const medicalDefaults = Array.isArray(filters.medicalLabels) ? filters.medicalLabels : [];
    form#lifeLogAnalyticsForm.life-log-analytics-form(data-analytics-mode="inline", data-analytics-auto=analyticsAutoRun ? 'true' : 'false', method="get", action="/mypage/life_log/analytics")
      .row.g-3
        .col-md-4
          label(for="life-log-analytics-start") Start
          input#life-log-analytics-start.form-control(type="datetime-local", name="start", value=filters.start)
        .col-md-4
          label(for="life-log-analytics-end") End
          input#life-log-analytics-end.form-control(type="datetime-local", name="end", value=filters.end)
        .col-md-4
          label(for="life-log-analytics-basic-labels") Basic labels
          select#life-log-analytics-basic-labels.form-select.life-log-analytics-select(name="basic_labels", multiple)
            each label in labelOptions
              - const isSelected = basicDefaults.includes(label);
              option(value=label, selected=isSelected)= label
          small.form-text.text-muted Blank = all basic labels.
      .row.g-3.mt-1
        .col-md-8
          label Entry types
          .d-flex.flex-wrap.gap-3.mt-2
            each option in typeOptions
              - const isChecked = filters.types && filters.types.length ? filters.types.includes(option.value) : (option.value === 'basic' || option.value === 'medical');
              label.form-check-label
                input.form-check-input(type="checkbox", name="types", value=option.value, data-analytics-type=option.value, checked=isChecked)
                | #{option.label}
        .col-md-4
          label(for="life-log-analytics-medical-labels") Medical labels
          select#life-log-analytics-medical-labels.form-select.life-log-analytics-select(name="medical_labels", multiple)
            each label in labelOptions
              - const isSelected = medicalDefaults.includes(label);
              option(value=label, selected=isSelected)= label
          small.form-text.text-muted Blank = all medical labels.
      .row.g-3.mt-1
        .col-md-4
          label Include legacy data
          .form-check.form-switch.mt-2
            input(type="hidden", name="include_legacy", value="false")
            input#life-log-analytics-legacy.form-check-input(type="checkbox", name="include_legacy", value="true", checked=filters.includeLegacy)
            span.form-check-label Include legacy health logs
        .col-md-8.d-flex.align-items-end.justify-content-end
          button.btn.btn-primary(type="submit") Run analytics
    .life-log-analytics-status.text-muted.mt-3(data-analytics-status) Select options and run analytics.
    .life-log-analytics-results.mt-4
      .life-log-analytics-panel(data-analytics-panel="numeric")
        h6.life-log-analytics-title Numeric trends
        .life-log-analytics-grid(data-analytics-numeric)
      .life-log-analytics-panel(data-analytics-panel="non-numeric")
        h6.life-log-analytics-title Non-numeric values
        .life-log-analytics-list(data-analytics-non-numeric)
      .life-log-analytics-panel(data-analytics-panel="diary")
        h6.life-log-analytics-title Diary entries
        .life-log-analytics-list(data-analytics-diary)
      .life-log-analytics-panel(data-analytics-panel="visual")
        h6.life-log-analytics-title Visual log overlay
        .life-log-visual-controls
          button.btn.btn-outline-secondary.btn-sm(type="button", data-visual-action="play") Play
          button.btn.btn-outline-secondary.btn-sm(type="button", data-visual-action="pause") Pause
          button.btn.btn-outline-secondary.btn-sm(type="button", data-visual-action="restart") Restart
        .life-log-visual-stage
          img#lifeLogVisualImage(src="/i/img_select.jpg", alt="Visual log overlay")
          canvas#lifeLogVisualCanvas
        .life-log-visual-caption.text-muted(data-visual-status)

block script
  script(src="/js/my_life_log_view.js")
